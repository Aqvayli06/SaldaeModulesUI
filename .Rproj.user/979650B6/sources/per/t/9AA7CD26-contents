app_server <- function(input, output, session) {
  tasga_n_tufra <- "./R/ayen_nnidhen/anekcum_uffir.rds"


  credentials <- callModule(shinyauthr::login, "login",
    data = readRDS(tasga_n_tufra),
    user_col = user,
    pwd_col = password_hash,
    sodium_hashed = TRUE,
    log_out = reactive(logout_init())
  )
  logout_init <- callModule(shinyauthr::logout, "logout", reactive(credentials()$user_auth))
  observe({
    if (credentials()$user_auth) {
      shinyjs::removeClass(selector = "body", class = "sidebar-collapse")
    } else {
      shinyjs::addClass(selector = "body", class = "sidebar-collapse")
    }
  })
  # setup any tab pages you want after login here with uiOutputs
  output$sidebar <- shinydashboard::renderMenu({
    req(credentials()$user_auth)
    shinydashboard::sidebarMenu(
      # Custom CSS to hide the default logout panel
      tags$head(tags$style(HTML(".shiny-server-account { display: none; }"))),
      # The dynamically-generated user panel
      uiOutput("userpanel"),
      shinydashboard::menuItem("POSEIDON", tabName = "POSEIDON", icon = shiny::icon("dashboard")),
      shinydashboard::menuItem("Renewables",
        icon = shiny::icon("solar-panel"), tabName = "Renewables",
        badgeLabel = "new", badgeColor = "green"
      ),
      shinydashboard::menuItem("Macroeconomics",
        icon = shiny::icon("fa-dollar-sign"), tabName = "Macroeconomics",
        badgeLabel = "In progress", badgeColor = "yellow"
      ),
      shinydashboard::menuItem("Visit-us",
        icon = shiny::icon("send"),
        href = "https://www.saldaeanalytics.com/#contact"
      )
    )
  })
  # . Market Data
  autoInvalidate <- reactiveTimer(120000)
  autoInvalidate2 <- reactiveTimer(900000)
  autoInvalidate_long <- reactiveTimer(900000)
  reBAP_tukciwin <- reactive({
    req(credentials()$user_auth)
    autoInvalidate()
    tasga_n_tukc_tura <- "./data_template/"
    reBAP_tura <- reBAP_for_Shiny(tasga_n_tukc = tasga_n_tukc_tura, reBAP_model = reBAP_ml_model, tala = "datacrawlR", ukud = input$date_reBap)
    return(reBAP_tura)
  })
  updated_time <- reactive({
    req(credentials()$user_auth)
    autoInvalidate2()
    tura <- lubridate::ceiling_date(Sys.time(), "15 minutes")
    if (base::as.Date(tura, tz = "CET") > input$date_reBap) {
      tura <- as.POSIXct(paste(input$date_reBap, "23:45"), tz = "CET")
    } else {
      tura <- lubridate::ceiling_date(Sys.time(), "15 minutes")
    }
    return(tura)
  })
  # .....................
  epex_spot_plot <- reactive({
    req(credentials()$user_auth)
    autoInvalidate2()
    cont_ID_price <- getIntradayContinuousEPEXSPOT(base::as.Date(input$date_reBap, tz = "CET"), base::as.Date(input$date_reBap, tz = "CET"), "15", "DE")
    plot_ID_data_farid(cont_ID_price)
  })
  output$expex_ID_price_plot <- plotly::renderPlotly({
    req(credentials()$user_auth)
    plotly::ggplotly(epex_spot_plot()[[1]])
  })

  output$expex_ID_volume_plot <- renderPlot({
    req(credentials()$user_auth)
    grid.arrange(epex_spot_plot()[[2]], epex_spot_plot()[[3]], nrow = 2, heights = c(0.5, 0.5))
  })
  # .....................
  output$epexspot_data <- renderDataTable({
    req(credentials()$user_auth)
    autoInvalidate2()
    EPEX_id_file <- paste0("./data_template/EPEX/ID_price_", format(Sys.Date(), "%Y_%m_%d"), ".RDS")
    # epex_prices<-get_epex_spot_tukciwin(ukud_tazwara = base::as.Date(input$date_reBap,tz="CET"),ukud_tagara=base::as.Date(input$date_reBap,tz="CET"),tamurt = "DE",EPEX_id_file=EPEX_id_file)
    # epex_prices<-get_epex_spot_tukciwin(ukud_tazwara = base::as.Date(input$date_reBap,tz="CET"),ukud_tagara=base::as.Date(input$date_reBap,tz="CET"),tamurt = "DE",EPEX_id_file=EPEX_id_file)
    epex_prices <- akred_epex_spot_tisefka()
    DT::datatable(epex_prices, options = list(
      initComplete = JS(
        "function(settings, json) {",
        "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
        "}"
      )
    )) %>%
      DT::formatStyle("Price", color = "black", backgroundColor = "grey", fontWeight = "bold")
  })
  #  time_slider_values<- reactive( {output$asbatri()})
  DA_price_forecast <- reactive({
    req(credentials()$user_auth)
    EP_DA_pred <- DA_ahead_prediction(ukud_tagara = Sys.Date() + 1, tamurt = "FR")
    return(EP_DA_pred)
  })
  output$expex_DA_price_forecast_data <- DT::renderDataTable({
    req(credentials()$user_auth)
    DA_price <- DA_price_forecast()
    DA_price <- DA_price[nrow(DA_price):1, ]
    rownames(DA_price) <- DA_price$DateTime
    DA_price$DateTime <- NULL
    DT::datatable(DA_price,
      filter = "top", selection = "multiple", escape = FALSE,
      options = list(sDom = '<"top">lrt<"bottom">ip', pageLength = 8, info = FALSE)
    )

    return(DA_price)
  })
  output$expex_DA_price_forecast_plot <- plotly::renderPlotly({
    req(credentials()$user_auth)
    sekned_EPEX(ass_ar_zdat_forecast = DA_price_forecast()) %>% plotly::layout(plot_bgcolor = background_colour, paper_bgcolor = background_colour)
  })


  output$reBAP_tukc <- DT::renderDataTable({
    req(credentials()$user_auth)
    autoInvalidate()

    reBAP_uttun <- reBAP_tukciwin()
    rownames(reBAP_uttun) <- substr(rownames(reBAP_uttun), start = 12, 16)
    reBAP_uttun$reBAP_to_ID <- sign(reBAP_uttun$reBAP - reBAP_uttun$IDh)
    DT::datatable(tail(reBAP_uttun, min(10, nrow(reBAP_uttun))), options = list(
      dom = "t",
      columnDefs = list(list(targets = 4, visible = FALSE))
    )) %>% formatStyle(
      "reBAP", "reBAP_to_ID",
      backgroundColor = styleEqual(c(-1, 0, 1), c("darkseagreen", "grey", "lightblue"))
    )
  })
  time_slider_values <- reactive({
    req(credentials()$user_auth)
    autoInvalidate()
    input$time_slider
  })

  output$plot_reBAP <- dygraphs::renderDygraph({
    req(credentials()$user_auth)
    autoInvalidate()
    taciwin_ukud <- time_slider_values()
    reBAP_tura <- reBAP_tukciwin()[, c("reBAP", "IDh"), drop = F]
    dygraphs::dygraph(reBAP_tura, main = "reBAP price estimation DE/AT/LUX") %>%
      dygraphs::dyRangeSelector(height = 20) %>%
      dygraphs::dyHighlight(highlightSeriesOpts = list(strokeWidth = 3))
  })

  # .Upload files
  tisefka_tizegzawin1 <- reactive({
    req(credentials()$user_auth)
    req(input$file1)
    tisefka <- ghred_tisefka_aqerru(input_file = input$file1, tala = input$tisefka_tala, tawriqt = input$excel_tawriqt)
    return(tisefka)
  })
  excel_tiwriqin <- reactive({
    if (is.null(input$tisefka_tala)) {
      return(NULL)
    }
    if (input$tisefka_tala != "EXCEL") {
      return(NULL)
    }
    if (input$tisefka_tala == "EXCEL") {
      return(readxl::excel_sheets(input$file1$datapath))
    }
  })

  output$excel_tawriqt <- renderUI({
    if (is.null(excel_tiwriqin())) {
      return(NULL)
    }
    shinyWidgets::pickerInput(
      inputId = "excel_tawriqt",
      label = "Choose excel sheet:",
      choices = excel_tiwriqin(),
      options = list(
        style = "btn-primary"
      )
    )
  })

  output$tisefka_tala <- renderUI({
    shinyWidgets::radioGroupButtons(
      inputId = "tisefka_tala",
      label = "Data Source :",
      choices = c(
        `<i class="fas fa-table"></i>` = "CSV", `<i class="fas fa-database"></i>` = "Database",
        `<i class="fas fa-file-excel"></i>` = "EXCEL"
      ),
      status = "success",
      justified = TRUE,
      selected = "CSV"
    )
  })


  output$date_variable <- renderUI({
    if (is.null(tisefka_tizegzawin1())) {
      return(NULL)
  }
    dates_yellan <- colnames(tisefka_tizegzawin1())
    dates_yellan <- text_similarity_f(target_text = dates_yellan, text_benchmark = "DATE")
    shinyWidgets::pickerInput(
      inputId = "date_variable",
      label = "Choose Date variable:",
      choices = dates_yellan,
      options = list(
        style = "btn-primary"
      )
    )
  })
  output$date_variable_help <- renderUI({
    req(tisefka_tizegzawin1())
    my_help_text <- h3("Once data is uploaded, you need to specify the variable to use for time (Date)", style = "color:navy")
    helpText(my_help_text)
  })
  output$SA_date_format <- renderUI({
    if (is.null(input$date_variable)) {
      return(NULL)
    }
    shinyWidgets::pickerInput(
      inputId = "SA_date_format",
      label = "Choose Date format:",
      choices = SA_date_format_yellan(),
      options = list(
        style = "btn-primary"
      )
    )
  })
  #-----------------------------------------------------------------------
  tisefka_tizegzawin <- reactive({
    req(credentials()$user_auth)
    if (is.null(tisefka_tizegzawin1())) {
      return(NULL)
    }
    tisefka <- sbed_tisefka(tisefka = tisefka_tizegzawin1(), date_variable = input$date_variable, SA_date_format = input$SA_date_format, spread_key = input$tisefka_spread, spread_value = input$tisefka_spread_var)
    return(tisefka)
  })
  #---------- in case of duplicated dates (grouping is required)--------
  output$tisefka_spread <- renderUI({
    req(input$date_variable)
    spread_choices <- tisefka_spread_yella(tisefka = tisefka_tizegzawin1(), date_index = input$date_variable)
    if(is.null(spread_choices)) {
      return(spread_choices)
    }
    spread_choices <- spread_choices[spread_choices != input$date_variable]
    shinyWidgets::pickerInput(
      inputId = "tisefka_spread",
      label = "There are duplicated dates, please spread your data",
      choices = spread_choices,
      options = list(
        style = "btn-primary"
      )
    )
  })
  output$tisefka_spread_var <- renderUI({
    req(input$date_variable)
    spread_value <- tisefka_spread_yella(tisefka = tisefka_tizegzawin1(), date_index = input$date_variable)
    if (is.null(spread_value)) {
      return(NULL)
    }
    spread_value <- colnames(tisefka_tizegzawin1())
    spread_value <- spread_value[spread_value != input$date_variable]
    spread_value <- spread_value[spread_value != input$tisefka_spread]
    shinyWidgets::pickerInput(
      inputId = "tisefka_spread_var",
      label = "spread value",
      choices = spread_value,
      options = list(
        style = "btn-primary"
      )
    )
  })
  tisefka_tizegzawin_d_ukud <- reactive({
    if (is.null(tisefka_tizegzawin())) {
      return(NULL)
    }
    #--------------------------------------------------------
    tisefka <- tisefkiwin_augmented_f(tisefka = tisefka_tizegzawin())
    # -------------------------------------------------------
    return(tisefka)
  })
  #-------------------------------------

output$color_theme1 <- renderUI({
    req(tisefka_tizegzawin1())
    colors_inu <-names(wesanderson::wes_palettes)
    shinyWidgets::pickerInput(inputId = "color_theme1",
                              choices =colors_inu,
                              selected = colors_inu)
})
  
color_palette_info1 <-reactive({
    if(is.null(input$color_theme1))return(NULL)
    fren_color(color_theme = input$color_theme1)
}) 
output$sekned_color_palette1 <- renderPlot({
    req(color_palette_info1())
    a <- color_palette_info1()$palette_inu
    return(a)
  },width = 100, height = 50)
  
output$colors_settings1 <- renderUI({
      fluidRow(
        col_6(uiOutput("color_theme1")),
        col_6(plotOutput("sekned_color_palette1",height = "60px"))
      )
  })

  #------------------------------------
  akka <- reactive({
    if (is.null(tisefka_tizegzawin1())) {
      return(NULL)
    }
    req(credentials()$user_auth)
    inserted_data <- inserted.data_raw <- tisefka_tizegzawin()
    # ............... Interpolate ,issing value ...........
    if (input$interpolation_ts == TRUE) {
      inserted_data <- interpolate_missing_values(ts_original = inserted_data, interpolation_mode = "kalman")
    }
    # . derive transformed data
    transform.output <- generate_transformed_features(
      n_time_series_original = inserted_data,
      year_growth_rate = TRUE,
      month_growth_rate = TRUE,
      x_trend = FALSE,
      x.cycle = FALSE,
      detect.int.order = FALSE
    )
    # . output.transform containt two objects : transformed.data and corresponding integration_order
    csv.data <- list()
    # .
    csv.data[["numeric.ts"]] <- transform.output$numeric.ts
    csv.data[["poor.ts"]] <- transform.output$poor.ts
    # . integration order
    csv.data[["integration_order"]] <- transform.output$integration_order
    # . akka a mmi a t ughael-d d aqerru
    csv.data[["inserted.data"]] <- inserted_data
    csv.data[["raw_data"]] <- inserted.data_raw
    csv.data[["transformed.data"]] <- transform.output$transformed.data
    if (input$outlier_correction == TRUE) {
      csv.data[["transformed.data"]] <- outliers_detection_function(ts_original = transform.output$transformed.data)
    }
    # .....................................................
    return(csv.data)
  })
  # . display data
  output$ImportedData <- renderTable({
    req(credentials()$user_auth)
    akka()$inserted.data
  })
  # .
  output$ImportedData2 <- renderDataTable({
    req(credentials()$user_auth)
    output_trafo_data <- akka()$transformed.data
    if ("DATE" %in% colnames(output_trafo_data)) {
      rownames(output_trafo_data) <- output_trafo_data$DATE
      output_trafo_data <- output_trafo_data[, colnames(output_trafo_data) != "DATE", drop = F]
    }
    output_trafo_data
  })

  numeric_variables <- reactive({
    req(data_summary())
    dat_diag <- data_summary()$diagnosis
    numericals <- dat_diag[grepl("numeric", dat_diag$types), "variables", drop = T]
    multi_integers <- dat_diag[grepl("integer", dat_diag$types), c("unique_count", "variables"), drop = T]
    if (nrow(multi_integers)) {
      multi_integers <- multi_integers[multi_integers["unique_count"] > 10, "variables", drop = T]
    } else {
      multi_integers <- NULL
    }
    return(c(numericals, multi_integers))
  })
  # Check boxes
  output$target_ts <- renderUI({
    req(numeric_variables())
    shinyWidgets::pickerInput(
      inputId = "target_ts",
      label = "Target Variable",
      choices = numeric_variables(),
      multiple = TRUE,
      selected = numeric_variables()[1],
      options = list(
        style = "btn-primary"
      )
    )
  })

  output$target_ts_exploration <- renderUI({
    req(numeric_variables())
    # Get the data set with the appropriate name
    # Create the checkboxes and select them all by default
    if (length(numeric_variables()) < 1) {
      return(NULL)
    }
    selectInput("target_ts_exploration", "Target Variable",
      choices = numeric_variables(),
      selected = numeric_variables()[1]
    )
  })
  #----------------------GROWTH RATE
  output$growth_rate_ih <- renderUI({
    req(numeric_variables())
    shinyWidgets::prettySwitch(
      inputId = "growth_rate_ih",
      label = "Growth Rate:",
      status = "success",
      fill = TRUE
    )
  })
  #------------
  output$growth_rate_yellan <- renderUI({
    req(credentials()$user_auth)
    if (is.null(input$growth_rate_ih)) {
      return(NULL)
    }
    if (input$growth_rate_ih == FALSE) {
      return(NULL)
    }
    gemmu_yellan <- gemmu_yellan_f(base_unit = input$time_unit_data)
    shinyWidgets::radioGroupButtons(
      inputId = "growth_rate_yellan",
      label = "Possible rates",
      choices = gemmu_yellan,
      justified = FALSE,
      status = "success",
      checkIcon = list(
        yes = shiny::icon("ok",
          lib = "glyphicon"
        )
      )
    )
  })
  #----------------Data Manipulation---------------
  #------------------------------------------------
  output$target_ts_manipulation_x <- renderUI({
    req(credentials()$user_auth)
    if (is.null(tisefka_tizegzawin1())) {
      return(NULL)
    }
    # Get the data set with the appropriate name
    # Create the checkboxes and select them all by default
    if (length(numeric_variables()) < 2) {
      return(NULL)
    }
    selectInput("target_ts_manipulation_x", "Choose your time series",
      multiple = FALSE,
      choices = numeric_variables(),
      selected = numeric_variables()[1]
    )
  })
  output$target_ts_manipulation_y <- renderUI({
    if (is.null(tisefka_tizegzawin1())) {
      return(NULL)
    }
    # Get the data set with the appropriate name
    # Create the checkboxes and select them all by default
    if (length(numeric_variables()) < 2) {
      return(NULL)
    }
    selectInput("target_ts_manipulation_y", "Choose your time series",
      multiple = FALSE,
      choices = numeric_variables(),
      selected = numeric_variables()[2]
    )
  })
  output$exogenous.ts <- renderUI({
    if (is.null(tisefka_tizegzawin1())) {
      return(NULL)
    }
    # Get the data set with the appropriate name
    exogenous_variable <- numeric_variables()
    exogenous_variable <- exogenous_variable[exogenous_variable != input$target_ts]
    if (length(exogenous_variable) == 0) {
      return(NULL)
    }
    if (input$forecast_type == "Uni") {
      return(NULL)
    }
    shinyWidgets::pickerInput(
      inputId = "exogenous.ts",
      label = "Exogenous Variables",
      choices = exogenous_variable,
      selected = exogenous_variable[1],
      options = list(
        style = "btn-primary"
      )
    )
  })
  # ..................... Summary ...........
  data_summary <- reactive({
    req(tisefka_tizegzawin_d_ukud())
    diag_output <- data_diagnosis_f(tisefka = tisefka_tizegzawin(), categoricals_ukud = tisefka_tizegzawin_d_ukud()$ukud_units)
    return(diag_output)
  })
  output$explore_table_view <- rhandsontable::renderRHandsontable({
    req(numeric_variables())
    Handson_exploration(tisefka = tisefka_tizegzawin(), numeric_variables = numeric_variables(), tisefka_report = data_summary())
  })

  output$data_diagnosis <- renderDataTable({
    req(data_summary())
    DT_diag <- data_quality_DT(data_summary()$diagnosis, target = "diagnosis")
    return(DT_diag)
  })
  # output$data_outliers <- renderDataTable({
  #   DT_outliers <- data_quality_DT(data_summary()$outliers,target ="outliers")
  #   return(DT_outliers)
  # })
  # . correlation plot
  output$corrplot <- renderPlot({
    req(credentials()$user_auth)
    csv.corr <- summary_function(tisefka = tisefka_tizegzawin(), integration_order = akka()$integration_order)$Correlation
    return(corrplot(csv.corr, order = "AOE", addCoef.col = "grey"))
  })

  forecast_objects <- eventReactive(input$generate_forecast, {
    # Generate Univariate forecast
    progress <- shiny::Progress$new()
    # Make sure it closes when we exit this reactive, even if there's an error
    on.exit(progress$close())
    progress$set(message = "Generate Forecast", value = 0)
    # Number of times we'll go through the loop
    n <- 100
    progress$inc(10 / n, detail = paste("Data preparation ...", 10, "%"))
    # ..............................................
    training_data <- akka()$transformed.data[, input$target_ts,drop=F]
    # ...............................................
    test_set <- NULL
    corrected <- training_data
    
    if (input$forecast_type == "Uni") {
      progress$inc(10 / n, detail = paste("Model training ...", 20, "%"))

      # SA_fcast_object <- arima_nnegh_aqerru(x =training_data , asurif_arzdat = fcast.horizon)
      training_data2 <<- training_data
      # SA_fcast_object <- time_based_ML_model_uni(tisefka = training_data , asurif_arzdat = fcast.horizon)
      asurif_arzdat <- min(floor(nrow(tisefka_tizegzawin()) / 3), 1000)
      
      SA_fcast_object <- purrr::map(colnames(training_data),function(x)Saldae_prophet(tisefka = training_data[,x,drop=F], asurif_zdat = asurif_arzdat))
      names(SA_fcast_object) <- colnames(training_data)
      # SA_fcast_object <- Saldae_prophet(tisefka = training_data, asurif_zdat = asurif_arzdat)
    } else {
      progress$inc(10 / n, detail = paste("Model training ...", 20, "%"))
      SA_multi_prophet_engine()
    }
    progress$inc(70 / n, detail = paste("output preparation ...", 90, "%"))
    
    
    for(ts_x in names(SA_fcast_object)){
      SA_fcast_object[[ts_x]]$raw_ts <- training_data[,ts_x,drop=F]
      SA_fcast_object[[ts_x]]$corrected <- corrected[,ts_x,drop=F]
      SA_fcast_object[[ts_x]]$test_set <- test_set  
    }
    progress$inc(10 / n, detail = paste("... Done.", 100, "%"))
    return(SA_fcast_object)
  })
  create_fcast_df <- reactive({
    req(credentials()$user_auth)
    fcast_object_plot <- purrr::map(forecast_objects(),sbed_forecast_aqerru,input$forecast_horizon_analytics)
    names(fcast_object_plot) <- names(forecast_objects())
    return(fcast_object_plot)
  })

  output$forecast_type <- renderUI({
    fcast_choices <- c("Univariate" = "Uni", "Multivariate" = "Mult")
    if (is.null(numeric_variables())) {
      return(NULL)
    }
    if (length(numeric_variables()) == 1) fcast_choices <- c("Univariate" = "Uni")
    shinyWidgets::radioGroupButtons(
      inputId = "forecast_type",
      label = "Forecast Type",
      choices = fcast_choices,
      justified = FALSE,
      status = "info",
      checkIcon = list(
        yes = shiny::icon("ok",
          lib = "glyphicon"
        )
      )
    )
  })

  output$outlier_correction <- renderUI({
    shinyWidgets::prettySwitch(
      inputId = "outlier_correction",
      label = "Outlier Correction",
      status = "success",
      fill = TRUE
    )
  })
  output$interpolation_ts <- renderUI({
    shinyWidgets::prettySwitch(
      inputId = "interpolation_ts",
      label = "Missing values",
      status = "success",
      fill = TRUE
    )
  })
  output$generate_forecast <- renderUI(
    shinyWidgets::actionBttn(
      inputId = "generate_forecast",
      label = "Generate Forecast",
      style = "pill",
      color = "success",
      icon = shiny::icon("chart")
    )
  )
  output$generate_forecast_report <- renderUI({
    shinyWidgets::downloadBttn(
      outputId = "export_pdf", label = "Analytics  Report", style = "unite",
      color = "default", size = "md", block = FALSE, no_outline = FALSE
    )
  })

  forecast_tira_report <- renderText({
    input$tira
  })

  output$plot_forecast <- plotly::renderPlotly({
    kan_akka()
  })
  forecast_tisefka_report <- reactive({
    DT::datatable(sekned_uttunen_forecast(fcast_tisefka = create_fcast_df()[[1]]))
  })
  kan_akka <- reactive({
    options(warn = -1)
    fcast_plots <- purrr::map(create_fcast_df(),sekned_forecast_aqeru, input$target_ts, background_colour, color_palette_info2())
    if(length(fcast_plots)>2){
      fcast_plots_lt <- fcast_plots[[1]]
      fcast_plots <- purrr::map(fcast_plots,function(x)plotly::style(p =x,showlegend =F))
      fcast_plots[[1]] <- fcast_plots_lt
      fcast_plots <- plotly::subplot(fcast_plots, margin = 0.06,nrows = 2)  
    }else{
      fcast_plots <- fcast_plots[[1]]
    }
    return(fcast_plots)
  })
  tisefka_acciwen <- reactive({
    if (is.null(tisefka_tizegzawin())) {
      return(NULL)
    }
    acciwen <- head(rownames(tisefka_tizegzawin()), 1)
    acciwen <- c(acciwen, tail(rownames(tisefka_tizegzawin()), 1))
    #------------------------
    fcast_horizon <- c(5, min(floor(nrow(tisefka_tizegzawin()) / 3), 1000))
    #------------------------
    acciwen_list <- list()
    acciwen_list$tisefka <- as.POSIXct(acciwen, tz = "CET")
    acciwen_list$asurif <- fcast_horizon
    #------------------------
    return(acciwen_list)
  })

  output$analytics_settings <- renderUI({
    req(tisefka_tizegzawin())
    uiOutput("plot_forecast_rnu")
    asurif <- afed_asurif_f(time_unit = ts_time_units()[1], base_unit = "seconds")
    acciwen <- tisefka_acciwen()
    shinyWidgets::dropdown(
      shinyWidgets::setSliderColor(color = c("#00AFBB", "#E1AF00"), sliderId = c(1, 2)),
      sliderInput(
        inputId = "actuals_used",
        label = "Specify the data to use for prediction:",
        min = acciwen$tisefka[1], max = acciwen$tisefka[2], step = asurif, value = c(acciwen$tisefka[1], acciwen$tisefka[2])
      ),
      sliderInput(
        inputId = "forecast_horizon_analytics",
        label = paste0("Specify the forecast horizon(", ts_time_units()[1], ")"),
        min = acciwen$asurif[1], max = acciwen$asurif[2], value = acciwen$asurif[2]
      ),
      uiOutput("colors_settings2"),
      
      style = "unite", icon = shiny::icon("gear"),
      status = "success", width = "300px",
      animate = shinyWidgets::animateOptions(
        enter = shinyWidgets::animations$fading_entrances$fadeInLeftBig,
        exit = shinyWidgets::animations$fading_exits$fadeOutRightBig
      )
    )
  })
  output$plot_forecast_rnu <- renderUI({
    shinyWidgets::prettyCheckbox(
      inputId = "plot_forecast_rnu",
      label = "SA_report",
      value = FALSE,
      status = "success",
      icon = shiny::icon("far fa-file-alt"),
      plain = TRUE,
      outline = TRUE
    )
  })
  output$report_type <- renderUI({
    report_types <- c("Html" = "Html", "Dashboard" = "Dashboard")
    if (is.null(numeric_variables())) {
      return(NULL)
    }
    shinyWidgets::radioGroupButtons(
      inputId = "report_type",
      label = NULL,
      choices = report_types,
      justified = FALSE,
      status = "info",
      checkIcon = list(
        yes = shiny::icon("ok",
          lib = "glyphicon"
        )
      )
    )
  })
  #------------------
  output$color_theme2 <- renderUI({
    req(tisefka_tizegzawin1())
    colors_inu <-names(wesanderson::wes_palettes)
    shinyWidgets::pickerInput(inputId = "color_theme2",
                              choices =colors_inu,
                              selected = colors_inu)
  })
  
  color_palette_info2 <-reactive({
    req(tisefka_tizegzawin1())
    if(is.null(input$color_theme2))return(NULL)
    fren_color(color_theme = input$color_theme2)
  }) 
  output$sekned_color_palette2 <- renderPlot({
    req(tisefka_tizegzawin1())
    a <- color_palette_info2()$palette_inu
    return(a)
  },width = 100, height = 50)
  
  output$colors_settings2 <- renderUI({
    fluidRow(
      col_6(uiOutput("color_theme2")),
      col_6(plotOutput("sekned_color_palette2",height = "60px"))
    )
  })
  
  
  
  
  #-----------------
  output$plot_forecast_box <- renderUI({
    req(credentials()$user_auth)
    shinydashboardPlus::boxPlus(
      title = "Forecast Output",
      closable = FALSE,
      width = 12,
      label_status = "success",
      solidHeader = FALSE,
      collapsible = TRUE,
      enable_dropdown = TRUE,
      dropdown_icon = "wrench",
      dropdown_menu = shinydashboardPlus::dropdownItemList(
        shinydashboardPlus::dropdownItem(url = "http://www.google.com", name = "Link to google"),
        shinydashboardPlus::dropdownItem(url = "#", name = "item 2"),
        shinydashboardPlus::dropdownDivider(),
        shinydashboardPlus::dropdownItem(url = "#", name = "item 3")
      ),
      fluidRow(
        column(
          width = 3,
          uiOutput("target_ts")
        ),
        column(
          width = 2,
          uiOutput("exogenous.ts")
        ),
        column(
          width = 3,
          uiOutput("forecast_type")
        ),
        column(
          width = 2,
          uiOutput("outlier_correction")
        ),
        column(
          width = 2,
          uiOutput("interpolation_ts")
        )
      ),
      uiOutput("analytics_settings"),
      plotly::plotlyOutput("plot_forecast"),

      fluidRow(
        column(
          width = 3,
          uiOutput("generate_forecast")
        ),
        column(
          width = 3,
          uiOutput("generate_forecast_report")
        ),
        column(
          3,
          uiOutput("report_type")
        )
      ),
      textInput("tira", label = h3("Add Comment:"), value = NULL)
    )
  })
  output$time_unit_input <- renderUI({
    req(credentials()$user_auth)
    time_units <- ts_time_units()
    if (length(time_units) == 0) time_units <- NULL
    shinyWidgets::radioGroupButtons(
      inputId = "time_unit_input",
      label = "Choose time frequency (summary) by",
      choices = time_units,
      status = "success",
      justified = FALSE,
      checkIcon = list(
        yes = shiny::icon("ok",
          lib = "glyphicon"
        )
      )
    )
  })

  ts_time_units <- reactive({
    return(possible_units_for_summary(time.vect = rownames(tisefka_tizegzawin())))
  })

  output$time_unit_data <- renderUI({
    # Get the data set with the appropriate name
    time_units <- ts_time_units()
    if (length(time_units) == 0) {
      return(NULL)
    }
    shinyWidgets::radioGroupButtons(
      inputId = "time_unit_data",
      label = "Aggregate by",
      choices = time_units,
      status = "success",
      justified = FALSE,
      checkIcon = list(
        yes = shiny::icon("ok",
          lib = "glyphicon"
        )
      )
    )
  })
  output$time_unit_bivariate <- renderUI({
    # Get the data set with the appropriate name
    time_units <- ts_time_units()[-1]
    if (length(time_units) == 0) {
      return(NULL)
    }
    shinyWidgets::awesomeRadio(
      inputId = "time_unit_bivariate", label = "Aggregate by", inline = TRUE,
      choices = time_units,
      status = "warning",
      selected = time_units[1]
    )
  })
  output$aggregation_metric <- renderUI({
    # Get the data set with the appropriate name
    if (is.null(input$time_unit_data)) {
      return(NULL)
    }
    if (ts_time_units()[1] != input$time_unit_data) {
      shinyWidgets::radioGroupButtons(
        inputId = "aggregation_metric",
        label = "Aggregation metric",
        choices = c("Sum", "Average", "Max", "Min"),
        justified = FALSE,
        status = "success",
        checkIcon = list(
          yes = shiny::icon("ok",
            lib = "glyphicon"
          )
        )
      )
    } else {
      return(NULL)
    }
  })

  annayen <- reactive({
    annayen_n_tumura_f()
  })
  #-------------------- business holidays 
  output$business_holidays <- renderUI({
    req(credentials()$user_auth)
    # Get the data set with the appropriate name
    if ("days" %in% ts_time_units()) {
      shinyWidgets::prettySwitch(
        inputId = "business_holidays",
        label = "Include Business Holidays",
        status = "success",
        fill = TRUE
      )
    }
  })

  #-------------------- business holidays 
  output$timura <- renderUI({
    timura <- names(annayen())
    if (is.null(input$business_holidays)) {
      return(NULL)
    }
    if (input$business_holidays == TRUE) {
      shinyWidgets::pickerInput("timura", "Countries:",
        multiple = F,
        choices = timura,
        selected = "GER",
        choicesOpt = list(
          content =
            mapply(timura, annayen(), FUN = function(country, flagUrl) {
              HTML(paste(
                tags$img(src = flagUrl, width = 20, height = 15),
                country
              ))
            }, SIMPLIFY = FALSE, USE.NAMES = FALSE)
        )
      )
    } else {
      NULL
    }
  })
  output$business_holidays_data <- renderDataTable({
    if (is.null(tisefka_tizegzawin1())) {
      return(NULL)
    }
    req(credentials()$user_auth)
    holidays_info <- get_business_holidays(tamurt = input$timura, dates = rownames(tisefka_tizegzawin()))
    return(holidays_info$business_holidays)
  })
  output$business_holidays_databox <- renderUI({
    shinydashboardPlus::boxPlus(
      title = "Business Holidays Overview",
      closable = FALSE,
      width = 12,
      label_status = "info",
      solidHeader = FALSE,
      collapsible = TRUE,
      enable_dropdown = TRUE,
      dropdown_icon = "wrench",
      dropdown_menu = shinydashboardPlus::dropdownItemList(
        shinydashboardPlus::dropdownItem(url = "http://www.google.com", name = "Link to google"),
        shinydashboardPlus::dropdownItem(url = "#", name = "item 2"),
        shinydashboardPlus::dropdownDivider(),
        shinydashboardPlus::dropdownItem(url = "#", name = "item 3")
      ),
      renderDataTable("business_holidays_data")
    )
  })
  #----------------- categoricals -------------------
  categoricals <- reactive({
    if (is.null(tisefka_tizegzawin1())) {
      return(NULL)
    }
    if (is.null(data_summary())) {
      return(NULL)
    }
    # categoricals_ukud <- ukud_acu_asdukkel(ukud_unit = input$time_unit_data)
    categoricals <- c(data_summary()$categoricals, tisefka_tizegzawin_d_ukud()$ukud_units)
    return(categoricals)
  })
  output$group_by <- renderUI({
  req(categoricals())
    # Get the data set with the appropriate name
    categ <- categoricals()
    if (length(categ) == 0) {
      return(NULL)
    }
    if (length(input$sdukkel_ih) == 0) {
      return(NULL)
    }
    if (input$sdukkel_ih == TRUE) {
      shinyWidgets::radioGroupButtons(
        inputId = "group_by",
        label = "Group by",
        choices = categ,
        status = "success",
        justified = FALSE,
        checkIcon = list(
          yes = shiny::icon("ok",
            lib = "glyphicon"
          )
        )
      )
    } else {
      return(NULL)
    }
  })
  #-------------------------Data exploration -------------

  output$group <- renderUI({
    req(numeric_variables())
    shinyWidgets::prettySwitch(
      inputId = "sdukkel_ih",
      label = "Grouping",
      status = "success",
      fill = TRUE
    )
  })
  output$ts_actions <- renderUI({
    if (length(ts_time_units()) == 0) {
      return(NULL)
    }
    ts_action_choices <- c("Smoothing", "Season. Adjust", "Anomaly")
    shinyWidgets::checkboxGroupButtons(
      inputId = "ts_actions",
      choices = ts_action_choices,
      status = "primary",
      checkIcon = list(
        yes = shiny::icon("ok",
          lib = "glyphicon"
        ),
        no = shiny::icon("remove",
          lib = "glyphicon"
        )
      )
    )
  })

  output$graph_type <- renderUI({
    req(categoricals())
    # graph_choices <- c("Lines","Markers","Lines+Markers","Filled","Bar")
    categ <- categoricals()
    plot_choices <- c(
      `<i class='fa fa-line-chart'></i>` = "Lines", `<i class='fas fa-circle'></i>` = "Markers", `<i class='fa fa-line-chart'></i>` = "Lines+Markers",
      `<i class='fas fa-chart-area'></i>` = "Filled", `<i class='fa fa-bar-chart'></i>` = "Bar", `<i class='fas fa-bell'></i>` = "Density"
    )
    if (length(input$sdukkel_ih) != 0) {
      if (length(categ) != 0 & input$sdukkel_ih == TRUE) {
        # "Lines","Stack","Bar","Scatter"
        plot_choices <- c(
          `<i class='fa fa-line-chart'></i>` = "Lines", `<i class='fas fa-circle'></i>` = "Scatter",
          `<i class='fa fa-bar-chart'></i>` = "Stack", `<i class='fa fa-bar-chart'></i>` = "Bar", `<i class='fas fa-bell'></i>` = "Density"
        )
      }
    }
    shinyWidgets::radioGroupButtons(
      inputId = "graph_type",
      choices = plot_choices,
      justified = FALSE,
      status = "success",
      selected = plot_choices[1]
    )
  })

  #------------------------------------  
  tisefka_asenqed <- reactive({
    req(tisefka_tizegzawin_d_ukud())
    tisefka <- data_exloration_aqerru(tisefka = tisefka_tizegzawin_d_ukud()$tisefka, tisefka_report = data_summary(), sdukkel = input$group_by, sdukkel_ih = input$sdukkel_ih, aggregation_metric = input$aggregation_metric, time_unit = input$time_unit_data, base_unit = ts_time_units()[1], target_ts = input$target_ts_exploration, ts_actions = input$ts_actions)
    return(tisefka)
  })
  view_exploration_rmd <- reactive({
    exploratory_plot <- sekned_tisefka(tisefka_report = tisefka_asenqed(), ts_actions = input$ts_actions, graph_type = input$graph_type,plot_settings = color_palette_info1())
    exploratory_plot <- exploratory_plot %>%
      plotly::layout(plot_bgcolor = background_colour, paper_bgcolor = background_colour) %>%
      plotly::config(displaylogo = F)
    exploratory_plot
  })
  output$view_exploration <- plotly::renderPlotly({
    return(view_exploration_rmd())
  })
  output$view_explorationbox <- renderUI({
    shinydashboardPlus::boxPlus(
      title = "Data View",
      closable = FALSE,
      width = 12,
      status = "success",
      solidHeader = FALSE,
      collapsible = TRUE,
      enable_dropdown = TRUE,
      dropdown_icon = "wrench",
      dropdown_menu = shinydashboardPlus::dropdownItemList(
        shinydashboardPlus::dropdownItem(url = "http://www.google.com", name = "Link to google"),
        shinydashboardPlus::dropdownItem(url = "#", name = "Generate Forecast"),
        shinydashboardPlus::dropdownDivider(),
        shinydashboardPlus::dropdownItem(url = "#", name = "Download report")
      ),
      uiOutput("ts_actions"),
      uiOutput("graph_type"),
      uiOutput("settings_exploration"),
      plotly::plotlyOutput("view_exploration")
    )
  })
  output$data_explorationbox <- renderUI({
    shinydashboardPlus::boxPlus(
      title = "Data Table",
      closable = FALSE,
      width = 12,
      status = "success",
      solidHeader = FALSE,
      collapsible = TRUE,
      enable_dropdown = TRUE,
      dropdown_icon = "wrench",
      dropdown_menu = shinydashboardPlus::dropdownItemList(
        shinydashboardPlus::dropdownItem(url = "http://www.google.com", name = "Link to google"),
        shinydashboardPlus::dropdownItem(url = "#", name = "item 2"),
        shinydashboardPlus::dropdownDivider(),
        shinydashboardPlus::dropdownItem(url = "#", name = "item 3")
      ),
      DT::dataTableOutput("data_exploration")
    )
  })

  output$data_exploration <- DT::renderDataTable({
    req(tisefka_asenqed())
    tisefka <- sekned_tisefka_DT(tisefka = tisefka_asenqed()$tisefka)
    DT::datatable(tisefka,
      filter = "top", selection = "multiple", escape = FALSE,
      options = list(sDom = '<"top">lrt<"bottom">ip', pageLength = 6, info = FALSE)
    )
  })
  output$settings_exploration <- renderUI({shinyWidgets::dropdown(
    uiOutput("colors_settings1"),
    #------ styling
    style = "unite", icon = shiny::icon("gear"),
    status = "success", width = "300px",
    animate = shinyWidgets::animateOptions(
      enter = shinyWidgets::animations$fading_entrances$fadeInLeftBig,
      exit = shinyWidgets::animations$fading_exits$fadeOutRightBig
    )
  )})
  #-------------------------Data exploration -------------
  output$data_exploration_box <- plotly::renderPlotly({
    req(credentials()$user_auth)
    exploratory_plot <- data_exloration_box(tisefka = tisefka_tizegzawin_d_ukud()$tisefka, x = input$group_by, y = input$target_ts_exploration, aggregation_metric = NULL)
    exploratory_plot <- exploratory_plot %>%
      plotly::layout(plot_bgcolor = background_colour, paper_bgcolor = background_colour) %>%
      plotly::config(displaylogo = F)
    return(exploratory_plot)
  })
  output$data_explorationstats <- renderUI({
    shinydashboardPlus::boxPlus(
      title = "Statistical View(boxplot)",
      closable = FALSE,
      width = 12,
      label_status = "primary",
      solidHeader = FALSE,
      collapsible = TRUE,
      enable_dropdown = TRUE,
      dropdown_icon = "wrench",
      dropdown_menu = shinydashboardPlus::dropdownItemList(
        shinydashboardPlus::dropdownItem(url = "http://www.google.com", name = "Link to google"),
        shinydashboardPlus::dropdownItem(url = "#", name = "item 2"),
        shinydashboardPlus::dropdownDivider(),
        shinydashboardPlus::dropdownItem(url = "#", name = "item 3")
      ),
      plotly::plotlyOutput("data_exploration_box")
    )
  })
  #-------------------------Data exploration(pie chart) -------------
  output$data_exploration_pie <- plotly::renderPlotly({
    req(credentials()$user_auth)
    exploratory_plot <- data_exploration_pie(tisefka = tisefka_tizegzawin_d_ukud()$tisefka, x = input$group_by, y = input$target_ts_exploration, aggregation_metric = NULL, bgrnd_color = background_colour) %>% plotly::config(displaylogo = F)
    return(exploratory_plot)
  })
  output$data_exploration_piebox <- renderUI({
    shinydashboardPlus::boxPlus(
      title = "Pie Chart",
      closable = FALSE,
      width = 12,
      label_status = "primary",
      solidHeader = FALSE,
      collapsible = TRUE,
      enable_dropdown = TRUE,
      dropdown_icon = "wrench",
      dropdown_menu = shinydashboardPlus::dropdownItemList(
        shinydashboardPlus::dropdownItem(url = "http://www.google.com", name = "Link to google"),
        shinydashboardPlus::dropdownItem(url = "#", name = "item 2"),
        shinydashboardPlus::dropdownDivider(),
        shinydashboardPlus::dropdownItem(url = "#", name = "item 3")
      ),
      plotly::plotlyOutput("data_exploration_pie")
    )
  })

  #--------------------------------------------------------
  #--------- Growth Rate

  gemmu_tisefka <- reactive({
    if (is.null(input$growth_rate_ih)) {
      return(NULL)
    }
    if (input$growth_rate_ih == FALSE) {
      return(NULL)
    }
    rate_n_gemmu <- rate_n_gemmu_f(tisefka_report = tisefka_asenqed(), gemmu_iswi = input$growth_rate_yellan)
    return(rate_n_gemmu)
  })

  output$sekned_gemmu <- plotly::renderPlotly({
    if (is.null(gemmu_tisefka())) {
      return(NULL)
    }
    sekned_gemmu_f(gemmu_tisefka()) %>% plotly::layout(plot_bgcolor = background_colour, paper_bgcolor = background_colour)
  })
  output$sekned_gemmubox <- renderUI({
    shinydashboardPlus::boxPlus(
      title = "Growth Rate",
      closable = FALSE,
      width = 12,
      status = "warning",
      solidHeader = FALSE,
      collapsible = TRUE,
      enable_dropdown = TRUE,
      dropdown_icon = "wrench",
      dropdown_menu = shinydashboardPlus::dropdownItemList(
        shinydashboardPlus::dropdownItem(url = "http://www.google.com", name = "Link to google"),
        shinydashboardPlus::dropdownItem(url = "#", name = "item 2"),
        shinydashboardPlus::dropdownDivider(),
        shinydashboardPlus::dropdownItem(url = "#", name = "item 3")
      ),
      uiOutput("growth_rate_yellan"),
      plotly::plotlyOutput("sekned_gemmu")
    )
  })

  #---------- Data Manipulation ---------------------------
  output$time_unit_manipulation <- renderUI({
    # Get the data set with the appropriate name
    time_units <- ts_time_units()[-1]
    if (length(time_units) == 0) {
      return(NULL)
    }
    shinyWidgets::awesomeRadio(
      inputId = "time_unit_manipulation", label = "Aggregate by", inline = TRUE,
      choices = time_units,
      status = "warning",
      selected = time_units[1]
    )
  })
  output$bivariate_stat_aggregation <- renderUI({
    # Get the data set with the appropriate name
    if (length(numeric_variables()) < 2) {
      return(NULL)
    }
    shinyWidgets::awesomeRadio(
      inputId = "bivariate_stat_aggregation", label = "Aggregation metric", inline = TRUE,
      choices = c("MAE", "MAPE", "COR", "RMSE"),
      status = "warning",
      selected = "MAE"
    )
  })
  tuqniwin <- reactive({
    tuqna_ts_akk(tisefka = tisefka_tizegzawin()[, numeric_variables(), drop = F])
  })

  output$tuqniwin_heat <- plotly::renderPlotly({
    req(credentials()$user_auth)
    tirghi_tuqniwin <- heatmap_interactive(tisefka = tuqniwin()$tuqniwin, reversescale = TRUE)
    tirghi_tuqniwin %>%
      plotly::layout(plot_bgcolor = background_colour, paper_bgcolor = background_colour) %>%
      plotly::config(displaylogo = F)
  })
  #---------------------data statistics on segment level 
  output$afeggag_wis_sin <- renderUI({
    req(credentials()$user_auth)
    shinyWidgets::prettyCheckbox(
      inputId = "afeggag_wis_sin", label = "Secondary Axis",
      status = "success", outline = TRUE
    )
  })
  output$tisefka_tayuga <- plotly::renderPlotly({
    req(credentials()$user_auth)
    bivariate_raw_plot_f <- bivariate_raw_plot_f(tisefka = tisefka_tizegzawin(), x = input$target_ts_manipulation_x, y = input$target_ts_manipulation_y, afeggag_wis_sin = input$afeggag_wis_sin)
    bivariate_raw_plot_f %>%
      plotly::layout(plot_bgcolor = background_colour, paper_bgcolor = background_colour) %>%
      plotly::config(displaylogo = F)
  })
  #--------------------Candle stick 
  tella_taftilt <- reactive({
    req(credentials()$user_auth)
    if (is.null(tisefka_tizegzawin())) {
      return(NULL)
    }
    if ("open" %in% colnames(tisefka_tizegzawin()) & "close" %in% colnames(tisefka_tizegzawin()) & "high" %in% colnames(tisefka_tizegzawin()) & "low" %in% colnames(tisefka_tizegzawin()) & "open" %in% colnames(tisefka_tizegzawin())) {
      return(TRUE)
    } else {
      return(NULL)
    }
  })
  output$taftilt <- plotly::renderPlotly({
    req(credentials()$user_auth)
    if (is.null(tella_taftilt())) {
      return(NULL)
    }
    taftilt_plot_f <- taftilt_tisefka_f(tisefka = tisefka_tizegzawin())
    taftilt_plot_f %>%
      plotly::layout(plot_bgcolor = background_colour, paper_bgcolor = background_colour) %>%
      plotly::config(displaylogo = F)
  })
  output$data_bivariate_group <- plotly::renderPlotly({
    req(credentials()$user_auth)
    bivariate_stats_dat <- data_manipulation_metric()$bivariate_metric_grouped
    if (is.null(bivariate_stats_dat)) {
      return(NULL)
    }
    bivariate_stat_plot <- bivariate_stat_plot(tisefka = bivariate_stats_dat, sdukkel = input$bivariate_stat_aggregation)
    bivariate_stat_plot <- bivariate_stat_plot + theme(plot.background = element_rect(fill = background_colour), panel.background = element_rect(fill = background_colour))
    plotly::ggplotly(bivariate_stat_plot)
  })

  output$kefrida <- renderUI({
    req(credentials()$user_auth)
    if (length(numeric_variables()) == 0) {
      return(NULL)
    }
    shinyWidgets::prettySwitch(
      inputId = "kefrida",
      label = "Waterfall",
      status = "success",
      fill = TRUE
    )
  })
  output$keferida_numericals <- renderUI({
    #
    req(credentials()$user_auth)
    if (is.null(input$kefrida)) {
      return(NULL)
    }
    if (input$kefrida == FALSE) {
      return(NULL)
    }
    shinyWidgets::checkboxGroupButtons(
      inputId = "keferida_numericals",
      label = "Choose Waterfall components:",
      choices = numeric_variables(),
      justified = TRUE,
      checkIcon = list(
        yes = shiny::icon("ok",
          lib = "glyphicon"
        )
      )
    )
  })
  output$keferida_go <- renderUI({
    #
    if (is.null(input$kefrida)) {
      return(NULL)
    }
    if (length(input$keferida_numericals) == 0) {
      return(NULL)
    }
    if (is.null(input$kefrida_aggregate)) {
      aggregates_kefrida <- NULL
    } else {
      num_aggregates <- min(input$kefrida_aggregate, floor(length(input$keferida_numericals) / 2))
      aggregates_kefrida <- rep("aggr.", times = num_aggregates)
    }
    shinyjqui::orderInput(inputId = "keferida_go", label = "Waterfall", items = c(input$keferida_numericals, aggregates_kefrida))
  })



  output$kefrida_aggregate <- renderUI({
    # .
    if (is.null(input$kefrida)) {
      return(NULL)
    }
    if (length(input$keferida_numericals) == 0) {
      return(NULL)
    }
    shinyWidgets::actionBttn(
      inputId = "kefrida_aggregate",
      label = "Add aggregate:",
      style = "stretch",
      color = "warning"
    )
  })



  output$kefrida_plot <- plotly::renderPlotly({
    req(credentials()$user_auth)
    if (length(input$keferida_go_order) < 2) {
      return(NULL)
    }
    kefrida_plot <- sekned_kefrida_f(tisefka = tisefka_tizegzawin(), kefrida_variables = input$keferida_go_order)
    kefrida_plot %>%
      plotly::layout(plot_bgcolor = background_colour, paper_bgcolor = background_colour) %>%
      plotly::config(displaylogo = F)
  })

  #------------------------------------------------------
  data_manipulation_metric <- reactive({
    tisefka_metric <- tisefka_urar_aqerr(tisefka = tisefka_tizegzawin(), x = input$target_ts_manipulation_x, y = input$target_ts_manipulation_y, aggregations = c("Correlation", "MAPE", "RMSE", "MASE"), time_unit = input$time_unit_bivariate, base_unit = ts_time_units()[1])
    return(tisefka_metric)
  })
  #--------------------------------------------------------
  output$data_metric1 <- flexdashboard::renderValueBox({
    req(credentials()$user_auth)
    tisefka_metric <- data_manipulation_metric()
    if (is.null(tisefka_metric)) {
      isem <- azal <- NULL
    } else {
      isem <- names(tisefka_metric)[1]
      azal <- paste0(tisefka_metric[[1]])
    }
    shinydashboard::valueBox(
      azal, isem,
      icon = shiny::icon("cog", lib = "glyphicon"),
      color = "green"
    )
  })
  output$data_metric2 <- flexdashboard::renderValueBox({
    req(credentials()$user_auth)
    tisefka_metric <- data_manipulation_metric()
    if (is.null(tisefka_metric)) {
      isem <- azal <- NULL
    } else {
      isem <- names(tisefka_metric)[2]
      azal <- paste0(tisefka_metric[[2]])
    }
    shinydashboard::valueBox(
      isem, azal,
      icon = shiny::icon("thumbs-up", lib = "glyphicon"),
      color = "orange"
    )
  })
  output$data_metric3 <- flexdashboard::renderValueBox({
    req(credentials()$user_auth)
    tisefka_metric <- data_manipulation_metric()
    if (is.null(tisefka_metric)) {
      isem <- azal <- NULL
    } else {
      isem <- names(tisefka_metric)[3]
      azal <- paste0(tisefka_metric[[3]])
    }
    shinydashboard::valueBox(
      isem, azal,
      icon = shiny::icon("thumbs-up", lib = "glyphicon"),
      color = "olive"
    )
  })
  #---------------------------------------------------------
  calculate_fcast_summary <- reactive({
    fcast_summary_wrapper(fcast_object = forecast_objects()[[1]])
  })
  plot_forecast_summary <- reactive({
    req(credentials()$user_auth)
    plot_output <- sekned_fcast_summary(fcast_summary = calculate_fcast_summary(), background_colour = background_colour, time_unit = input$time_unit_input)
    return(plot_output)
  })
  plot_forecast_summary_sum <- reactive({
    req(credentials()$user_auth)
    plotly::ggplotly(plot_forecast_summary()[["plot_fcast_summary_sum"]])
  })
  output$plot_forecast_summary_sum <- plotly::renderPlotly({
    plot_forecast_summary_sum()
  })
  

  
  output$plot_forecast_summary_sum_box <- renderUI({
    req(credentials()$user_auth)
    shinydashboardPlus::boxPlus(
      title = "Forecast Summary (Sum):",
      closable = FALSE,
      width = 12,
      label_status = "warning",
      solidHeader = FALSE,
      collapsible = TRUE,
      enable_dropdown = TRUE,
      dropdown_icon = "wrench",
      dropdown_menu = shinydashboardPlus::dropdownItemList(
        shinydashboardPlus::dropdownItem(url = "http://www.google.com", name = "Link to google"),
        shinydashboardPlus::dropdownItem(url = "#", name = "item 2"),
        shinydashboardPlus::dropdownDivider(),
        shinydashboardPlus::dropdownItem(url = "#", name = "item 3")
      ),
      plotly::plotlyOutput("plot_forecast_summary_sum")
    )
  })

  plot_forecast_summary_mean <- reactive({
    req(credentials()$user_auth)
    plotly::ggplotly(plot_forecast_summary()[["plot_fcast_summary_mean"]])
  })
  output$plot_forecast_summary_mean <- plotly::renderPlotly({
    plot_forecast_summary_mean()
  })
  output$plot_forecast_summary_mean_box <- renderUI({
    req(credentials()$user_auth)
    shinydashboardPlus::boxPlus(
      title = "Forecast Summary (Average)",
      closable = FALSE,
      width = 12,
      label_status = "warning",
      solidHeader = FALSE,
      collapsible = TRUE,
      enable_dropdown = TRUE,
      dropdown_icon = "wrench",
      dropdown_menu = shinydashboardPlus::dropdownItemList(
        shinydashboardPlus::dropdownItem(url = "http://www.google.com", name = "Link to google"),
        shinydashboardPlus::dropdownItem(url = "#", name = "item 2"),
        shinydashboardPlus::dropdownDivider(),
        shinydashboardPlus::dropdownItem(url = "#", name = "item 3")
      ),
      plotly::plotlyOutput("plot_forecast_summary_mean")
    )
  })
  # ....Downloadable csv of selected dataset..........
  data_template <- reactive({
    date_file_name <- file.path("data_template", "saldae_data_template.csv")
    read.csv(date_file_name)
  })
  output$data_template <- downloadHandler(
    filename = function() {
      "saldae_data_template.csv"
    },
    content = function(filename) {
      write.csv(data_template(), file = filename, row.names = FALSE)
    }
  )
  #--------------------------------------
  output$export_pdf <- downloadHandler(
    # For PDF output, change this to "report.pdf"
    filename = paste0("Saldae_Report_", user_info()$user, "_", format(Sys.time(), "%Y%m%d_%H%M"), ".html"),
    content = function(file) {
      # Copy the report file to a temporary directory before processing it, in
      # case we don't have write permissions to the current working dir (which
      # can happen when deployed).
      if (input$report_type == "Html") {
        output_file_name <- file.path("inst", "app", "report", "sa_shiny_report_html.Rmd")

        tempReport <- file.path(getwd(), output_file_name)
      }
      #
      if (input$report_type == "Dashboard") {
        output_file_name <- file.path("inst", "app", "report", "sa_shiny_report_dashboard.Rmd")
        tempReport <- file.path(getwd(), output_file_name)
      }
      
      forecast_object <- kan_akka()
      tisefka_object <- view_exploration_rmd()
      Saldae_author <- user_info()$user
      Forecast_tisefka <- forecast_tisefka_report()
      Forecast_tira <- forecast_tira_report()
      forecast_summary_mean <- plot_forecast_summary_mean()
      forecast_summary_sum <- plot_forecast_summary_sum()

      params <- list(
        forecast_object = forecast_object,
        tisefka_object = tisefka_object,
        Saldae_author = Saldae_author,
        Forecast_tisefka = Forecast_tisefka,
        Forecast_tira = Forecast_tira,
        forecast_summary_sum = forecast_summary_sum,
        forecast_summary_mean = forecast_summary_mean
      )
      # Knit the document, passing in the `params` list, and eval it in a
      # child of the global environment (this isolates the code in the document
      # from the code in this app).
     
    
      
      web_site_path <- file.path("/..","usr","share","nginx","html")
      dir.create(web_site_path)
      rmarkdown::render(
        input = tempReport, output_file = "SA_dashboard_view",
        params = params,
        output_dir = web_site_path,
        envir = new.env(parent = globalenv())
      )
      
      rmarkdown::render(
        input = tempReport, output_file = file,
        params = params,
        envir = new.env(parent = globalenv())
      )
      # rmarkdown::render_site(
      #   input = tempReport
      # )
    }
  )

  #---------------------Macro-economics 
  output$plot_macro_data <- dygraphs::renderDygraph({
    req(credentials()$user_auth)
    macro_data <- macro_data_crawler(acu_text = input$Macro_indicator, ukud_tazwara = "2000-01-01", ukud_tagara = Sys.Date())
    colnames(macro_data) <- c("DATE", "MACRO")
    MACRO <- macro_data$MACRO
    MACRO <- xts::xts(x = MACRO, order.by = as.POSIXct(macro_data$DATE, tz = "CET"))
    dygraphs::dygraph(MACRO, main = input$Macro_indicator) %>%
      dygraphs::dyRangeSelector(height = 20) %>%
      dygraphs::dySeries("V1", label = input$Macro_indicator) %>%
      dygraphs::dyLegend(show = "always", hideOnMouseOut = FALSE)
  })
  #-----------------------------------

  output$plot_stock_market <- dygraphs::renderDygraph({
    req(credentials()$user_auth)
    autoInvalidate_long()
    stock_market_prices <- get_stock_market_data(start_Date = Sys.Date() - 100, end_Date = Sys.Date())
    dygraphs::dygraph(data = stock_market_prices) %>%
      dygraphs::dyCandlestick() %>%
      dygraphs::dyRangeSelector()
  })
  #------------------------------Authetification------------------
  user_info <- reactive({
    credentials()$info
  })
  output$rnudmamaynut <- renderUI({
    print("aqli daha")
    if (user_info()$permissions == "admin") {
      observe({
        if (!is.null(input$adduser)) {
          if (input$adduser > 0) {
            Username <- isolate(input$userName)
            Password <- isolate(input$passwd)
            rnu_amdan <- rnu_negh_ekkes_amdan(
              tasga_n_tufra = tasga_n_tufra,
              isem = Username, awal_uffir = Password
            )
            if (rnu_amdan) {
              shinyjs::toggle(id = "yerna", anim = TRUE, time = 1, animType = "fade")
            } else {
              shinyjs::toggle(id = "nomatch", anim = TRUE, time = 1, animType = "fade")
              shinyjs::delay(3000, shinyjs::toggle(id = "nomatch", anim = TRUE, time = 1, animType = "fade"))
            }
          }
        }
      })
      loginpage
    }
  })
  # ......................TAGARA....................................
  # Automatically stop a Shiny app when closing the browser tab
  session$onSessionEnded(stopApp)
}
